{% extends 'registration/job/base.html' %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .template-sender-container { display: flex; flex-wrap: wrap; gap: 30px; }
    .sender-panel { flex: 2; min-width: 400px; }
    .preview-panel { flex: 1; min-width: 320px; }
    .form-group { margin-bottom: 1.5rem; }
    .send-button { width: 100%; padding: 12px; margin-top: 20px; font-size: 1.1em; background-color: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
    .send-button:disabled { background-color: #999; cursor: not-allowed; }
    .phone-preview { width: 320px; height: 580px; background: #111; border-radius: 40px; padding: 15px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .phone-screen { background: #ece5dd; height: 100%; border-radius: 25px; padding: 10px; display: flex; flex-direction: column; font-family: sans-serif; overflow-y: auto; }
    .preview-bubble { background: #fff; padding: 10px 12px; border-radius: 8px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); max-width: 90%; font-size: 14px; line-height: 1.4; word-break: break-word; white-space: pre-wrap; align-self: flex-start; }
    .preview-bubble p { margin: 0; }
    .preview-button-container { border-top: 1px solid #f0f0f0; margin-top: 10px; padding-top: 10px; }
    .preview-button { background: #f8f8f8; color: #007bff; text-align: center; padding: 10px; border-radius: 8px; font-size: 14px; cursor: pointer; }
    #api-response-pre { background-color: #282c34; color: #abb2bf; padding: 15px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; }
    .select2-container .select2-selection--multiple { border: 1px solid #ced4da; padding: .375rem .75rem; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="template-sender-container">
        <div class="sender-panel">
            <h2>Send WhatsApp Flow</h2>
            <p>Select an approved Flow template and choose recipients to start the form.</p>
            
            <form id="sender-form">
                {% csrf_token %}
                <input type="hidden" name="template_name" id="hidden-template-name">
                <input type="hidden" name="flow_id" id="hidden-flow-id">

                <div class="form-group">
                    <label for="template-select"><b>1. Select Flow Template</b></label>
                    <select id="template-select" class="form-control" disabled>
                        <option value="" selected>Loading templates...</option>
                    </select>
                </div>

                <div id="dynamic-fields" class="mt-3" style="display: none;">
                    <div class="form-group">
                        <label for="contact-select"><b>2. Select Recipients</b></label>
                        <select id="contact-select" name="recipients[]" class="form-control" multiple required>
                            {% for c in contacts %}<option value="{{ c.wa_id }}">{{ c.name|default:c.wa_id }}</option>{% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="send-button">Send Flow</button>
                </div>
            </form>
        </div>
        <div class="preview-panel">
            <h4>Live Preview</h4>
            <div class="phone-preview">
                <div class="phone-screen" id="phone-screen-preview">
                    <!-- Preview will be rendered here -->
                    <div class="preview-bubble" style="color: #888;">Select a template to see the preview.</div>
                </div>
            </div>
        </div>
    </div>
    <div id="response-container" class="mt-4" style="display:none;">
        <h4>API Response</h4>
        <pre id="api-response-pre"></pre>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- URLs provided by Django ---
    const getTemplatesUrl = "{% url 'registration:get_flow_templates' %}";
    const sendTemplateUrl = "{% url 'registration:send_flow_template' %}";
    const csrfToken = "{{ csrf_token }}";

    // --- DOM Elements ---
    const senderForm = document.getElementById('sender-form');
    const templateSelect = document.getElementById('template-select');
    const contactSelect = document.getElementById('contact-select');
    const dynamicFields = document.getElementById('dynamic-fields');
    const phoneScreen = document.getElementById('phone-screen-preview');
    const responseContainer = document.getElementById('response-container');
    const apiResponsePre = document.getElementById('api-response-pre');

    let flowTemplates = [];

    // --- Initialize Select2 for a better multi-select UI ---
    $(contactSelect).select2({ placeholder: "Choose contacts...", allowClear: true });

    // --- Fetch Flow Templates from the Backend ---
    async function fetchFlowTemplates() {
        try {
            const response = await fetch(getTemplatesUrl, {
                headers: { 'X-CSRFToken': csrfToken }
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                flowTemplates = result.flow_templates.filter(t => t.status === 'APPROVED');
                populateTemplateDropdown();
            } else {
                templateSelect.innerHTML = `<option value="">Error loading templates</option>`;
                console.error('Failed to fetch templates:', result.message);
            }
        } catch (error) {
            templateSelect.innerHTML = `<option value="">Error loading templates</option>`;
            console.error('Error fetching flow templates:', error);
        }
    }

    // --- Populate the Dropdown with Fetched Templates ---
    function populateTemplateDropdown() {
        templateSelect.innerHTML = `<option value="" disabled selected>-- Choose a flow template --</option>`;
        if (flowTemplates.length > 0) {
            flowTemplates.forEach(t => {
                const option = document.createElement('option');
                option.value = t.name;
                option.textContent = `${t.name} (Status: ${t.status})`;
                templateSelect.appendChild(option);
            });
            templateSelect.disabled = false;
        } else {
            templateSelect.innerHTML = `<option value="">No approved flow templates found</option>`;
        }
    }

    // --- Update UI and Preview on Template Selection ---
    templateSelect.addEventListener('change', (e) => {
        const selectedTemplateName = e.target.value;
        const template = flowTemplates.find(t => t.name === selectedTemplateName);
        if (!template) return;

        // Store data in hidden fields for submission
        senderForm.querySelector('#hidden-template-name').value = template.name;
        senderForm.querySelector('#hidden-flow-id').value = template.flow_id;
        
        dynamicFields.style.display = 'block';
        updatePreview(template);
    });

    function updatePreview(template) {
        // Find the body component to display its text
        const bodyComponent = template.components?.find(c => c.type === 'BODY');
        const bodyText = bodyComponent?.text || "This is a form.";

        phoneScreen.innerHTML = `
            <div class="preview-bubble">
                <p>${bodyText}</p>
                <div class="preview-button-container">
                    <div class="preview-button">${template.button_text || 'Start Form'}</div>
                </div>
            </div>
        `;
    }

    // --- Handle Form Submission ---
    senderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(senderForm);
        const sendButton = senderForm.querySelector('.send-button');
        
        sendButton.disabled = true;
        sendButton.textContent = 'Sending...';
        responseContainer.style.display = 'none';

        try {
            const response = await fetch(sendTemplateUrl, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            });
            const result = await response.json();
            apiResponsePre.textContent = JSON.stringify(result, null, 2);
            responseContainer.style.display = 'block';
        } catch (error) {
            apiResponsePre.textContent = JSON.stringify({ error: error.message }, null, 2);
            responseContainer.style.display = 'block';
        } finally {
            sendButton.disabled = false;
            sendButton.textContent = 'Send Flow';
        }
    });

    // --- Initial Load ---
    fetchFlowTemplates();
});
</script>
{% endblock %}
