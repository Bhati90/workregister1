{% extends 'registration/job/base.html' %}

{% block extra_head %}
<style>
    .chat-container { max-height: 70vh; overflow-y: auto; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .chat-wrapper { display: flex; flex-direction: column; }
    .chat-bubble { max-width: 70%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; word-wrap: break-word; }
    .inbound { background-color: #f1f0f0; align-self: flex-start; }
    .outbound { background-color: #dcf8c6; align-self: flex-end; }
    .bubble-footer { display: flex; justify-content: flex-end; align-items: center; gap: 5px; font-size: 0.75rem; color: #999; margin-top: 5px; }
    .status-read { color: #53bdeb; }
    .replied-to-block { background-color: rgba(0, 0, 0, 0.05); padding: 8px; border-radius: 8px; border-left: 3px solid #007bff; margin-bottom: 8px; }
    .replied-to-block p { margin: 0; font-size: 0.9em; color: #555; }
    .contact-card { background-color: #fafafa; border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
    .caption { margin-top: 5px; font-size: 0.9em; color: #333; }
    .chat-bubble { position: relative; }
    .reply-btn {
        position: absolute; top: 5px; right: 5px;
        background: rgba(0,0,0,0.1); border: none; border-radius: 50%;
        width: 24px; height: 24px; cursor: pointer;
        display: none; align-items: center; justify-content: center;
    }
    .chat-bubble:hover .reply-btn { display: flex; }
    #reply-context-banner {
        display: none; padding: 8px; background: #f0f0f0;
        border-left: 3px solid #007bff; margin-bottom: 5px; border-radius: 4px;
    }
    #reply-context-banner p { margin: 0; font-size: 0.9em; font-style: italic; }
    #cancel-reply-btn { margin-left: 10px; cursor: pointer; font-weight: bold; }

</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Chat with {{ contact.name|default:contact.wa_id }}</h3>

    <div class="chat-container my-3" id="chat-container">
        <div class="chat-wrapper" id="chat-wrapper">
            {% for message in messages %}
            <div class="chat-bubble {{ message.direction }}">
                <button class="reply-btn" data-wamid="{{ message.wamid }}" data-text="{{ message.text_content|truncatechars:30 }}">â†ª</button>
                
                {% if message.replied_to %}
                <div class="replied-to-block">
                    <strong>{{ message.replied_to.contact.name|default:message.replied_to.contact.wa_id }}</strong>
                    <p>{{ message.replied_to.text_content|truncatechars:50 }}</p>
                </div>
                {% endif %}

                {% if message.message_type == 'image' and message.media_file %}
                    <img src="{{ message.media_file.url }}" alt="Image" style="max-width: 100%; border-radius: 10px;">
                {% elif message.message_type == 'video' and message.media_file %}
                    <video controls style="max-width: 100%; border-radius: 10px;"><source src="{{ message.media_file.url }}"></video>
                {% elif message.message_type == 'audio' and message.media_file %}
                    <audio controls src="{{ message.media_file.url }}"></audio>
                {% elif message.message_type == 'contact' %}
                    <div class="contact-card">
                        <p class="mb-1">{{ message.text_content|linebreaksbr }}</p>
                    </div>
                {% else %}
                    <p class="mb-1">{{ message.text_content|linebreaksbr }}</p>
                {% endif %}
                
                {% if message.caption %}
                    <p class="caption">{{ message.caption }}</p>
                {% endif %}

                <div class="bubble-footer">
                    <span>{{ message.timestamp|date:"h:i A" }}</span>
                    {% if message.direction == 'outbound' %}
                        {% if message.status == 'read' %}
                            <span class="status-read">âœ“âœ“</span>
                        {% elif message.status|slice:":8" == 'Reacted' %}
                            <span class="status-read">{{ message.status|slice:"13:" }}</span>
                        {% elif message.status == 'delivered' %}
                            <span>âœ“âœ“</span>
                        {% else %}
                            <span>âœ“</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="reply-context-banner">
        <span id="reply-context-text"></span>
        <span id="cancel-reply-btn">âœ–</span>
    </div>

    <form id="reply-form" enctype="multipart/form-data">
        <input type="hidden" id="replied-to-wamid" name="replied_to_wamid">
        <div class="input-group">
            <input type="text" id="reply-message-input" class="form-control" placeholder="Type a message...">
            <label class="btn btn-secondary mb-0" for="media-file-input">ðŸ“Ž</label>
            <input type="file" id="media-file-input" name="media_file" style="display: none;">
            <button type="submit" class="btn btn-primary">Send</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatContainer = document.getElementById('chat-container');
    const replyForm = document.getElementById('reply-form');
    const messageInput = document.getElementById('reply-message-input');
    const repliedToWamidInput = document.getElementById('replied-to-wamid');
    const replyBanner = document.getElementById('reply-context-banner');
    const replyBannerText = document.getElementById('reply-context-text');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    const csrfToken = "{{ csrf_token }}";


    // Scroll to the bottom of the chat on page load
    chatContainer.scrollTop = chatContainer.scrollHeight;

    document.querySelectorAll('.reply-btn').forEach(button => {
        button.addEventListener('click', () => {
            const wamid = button.dataset.wamid;
            const text = button.dataset.text;
            repliedToWamidInput.value = wamid;
            replyBannerText.textContent = `Replying to: "${text}"`;
            replyBanner.style.display = 'block';
            messageInput.focus();
        });
    });

    cancelReplyBtn.addEventListener('click', () => {
        repliedToWamidInput.value = '';
        replyBanner.style.display = 'none';
    });

    replyForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const messageText = messageInput.value.trim();
        const file = mediaInput.files[0];

        // --- THIS IS THE MISSING FIX ---
        // If there is no text AND no file, do not submit the form.
        if (!messageText && !file) {
            return; 
        }
        const formData = new FormData(replyForm);
        formData.append('to_number', "{{ contact.wa_id }}");
        formData.append('message_text', messageText); // Ensure trimmed text is what's sent

        messageInput.disabled = true;

        try {
            const response = await fetch("{% url 'registration:send_reply_api' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData,
            });
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to send message. Please check the server logs.');
                messageInput.disabled = false;
            }
        } catch (error) {
            console.error('Error sending reply:', error);
            alert('An error occurred.');
            messageInput.disabled = false;
        }
    });
});
</script>
{% endblock %}