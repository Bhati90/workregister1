{% extends 'registration/job/base.html' %}

{% block extra_head %}
<style>
    .chat-container { max-height: 70vh; overflow-y: auto; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .chat-bubble { max-width: 70%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; word-wrap: break-word; }
    .inbound { background-color: #f1f0f0; align-self: flex-start; }
    .outbound { background-color: #dcf8c6; align-self: flex-end; }
    .chat-wrapper { display: flex; flex-direction: column; }
    .message-status { font-size: 0.75rem; color: #999; text-align: right; }
    .status-read { color: #53bdeb; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Chat with {{ contact.name|default:contact.wa_id }}</h3>

    <div class="chat-container my-3" id="chat-container">
        <div class="chat-wrapper" id="chat-wrapper">
            {% for message in messages %}
                <div class="chat-bubble {{ message.direction }}">
                    {% if message.message_type == 'image' %}
                        <img src="{{ message.media_url }}" alt="Image from user" style="max-width: 100%; border-radius: 10px;">
                    {% else %}
                        <p class="mb-1">{{ message.text_content|linebreaksbr }}</p>
                    {% endif %}
                    <div class="message-status">
                        <span>{{ message.timestamp|date:"h:i A" }}</span>
                        {% if message.direction == 'outbound' %}
                            {% if message.status == 'read' %}
                                <span class="status-read">✓✓</span>
                            {% elif message.status == 'delivered' %}
                                <span>✓✓</span>
                            {% else %}
                                <span>✓</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <form id="reply-form">
        <div class="input-group">
            <input type="text" id="reply-message-input" class="form-control" placeholder="Type your message...">
            <button type="submit" class="btn btn-primary">Send</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatContainer = document.getElementById('chat-container');
    const replyForm = document.getElementById('reply-form');
    const messageInput = document.getElementById('reply-message-input');
    const contactWaId = "{{ contact.wa_id }}";
    const csrfToken = "{{ csrf_token }}";

    // Scroll to the bottom of the chat
    chatContainer.scrollTop = chatContainer.scrollHeight;

    replyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageText = messageInput.value.trim();
        if (!messageText) return;

        messageInput.disabled = true; // Disable input while sending

        try {
            const response = await fetch("{% url 'registration:send_reply_api' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    to_number: contactWaId,
                    message_text: messageText,
                }),
            });

            if (response.ok) {
                // For a full experience, you'd add the new message to the UI here
                // For now, we'll just reload the page to see the new message
                window.location.reload();
            } else {
                alert('Failed to send message.');
                messageInput.disabled = false;
            }
        } catch (error) {
            console.error('Error sending reply:', error);
            alert('An error occurred.');
            messageInput.disabled = false;
        }
    });
});
</script>
{% endblock %}