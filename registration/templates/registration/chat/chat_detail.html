{% extends 'registration/job/base.html' %}

{% block extra_head %}
<style>
    .chat-container { max-height: 70vh; overflow-y: auto; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .chat-wrapper { display: flex; flex-direction: column; }
    .chat-bubble { max-width: 70%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; word-wrap: break-word; }
    .inbound { background-color: #f1f0f0; align-self: flex-start; }
    .outbound { background-color: #dcf8c6; align-self: flex-end; }
    .bubble-footer { display: flex; justify-content: flex-end; align-items: center; gap: 5px; font-size: 0.75rem; color: #999; margin-top: 5px; }
    .status-read { color: #53bdeb; }
    .replied-to-block { background-color: rgba(0, 0, 0, 0.05); padding: 8px; border-radius: 8px; border-left: 3px solid #007bff; margin-bottom: 8px; }
    .replied-to-block p { margin: 0; font-size: 0.9em; color: #555; }
    .contact-card { background-color: #fafafa; border: 1px solid #ddd; padding: 10px; border-radius: 8px; }
    .caption { margin-top: 5px; font-size: 0.9em; color: #333; }
    .chat-bubble { position: relative; }
    .reply-btn {
        position: absolute; top: 5px; right: 5px;
        background: rgba(0,0,0,0.1); border: none; border-radius: 50%;
        width: 24px; height: 24px; cursor: pointer;
        display: none; align-items: center; justify-content: center;
    }
    .chat-bubble:hover .reply-btn { display: flex; }
    #reply-context-banner {
        display: none; padding: 8px; background: #f0f0f0;
        border-left: 3px solid #007bff; margin-bottom: 5px; border-radius: 4px;
    }
    .reaction-emoji {
    position: absolute;
    bottom: -10px;
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 50%;
    padding: 1px 6px;
    font-size: 0.8rem;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.outbound .reaction-emoji { right: 20px; }
.inbound .reaction-emoji { left: 20px; }
    #reply-context-banner p { margin: 0; font-size: 0.9em; font-style: italic; }
    #cancel-reply-btn { margin-left: 10px; cursor: pointer; font-weight: bold; }
.highlight {
    /* This will create a pulsing blue glow effect */
    animation: highlight-animation 1.5s ease-out;
}

@keyframes highlight-animation {
    0%, 100% {
        box-shadow: none;
    }
    25%, 75% {
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.4);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Chat with {{ contact.name|default:contact.wa_id }}</h3>

    <div class="chat-container my-3" id="chat-container">
        <div class="chat-wrapper" id="chat-wrapper">
            {% for message in messages %}
            <div class="chat-bubble {{ message.direction }}" id="{{ message.wamid }}">
                <button class="reply-btn" data-wamid="{{ message.wamid }}" data-text="{{ message.text_content|default:message.caption|default:'Media'|truncatechars:30 }}">‚Ü™</button>
                
                {% if message.replied_to %}
                <a href="#{{ message.replied_to.wamid }}" class="replied-to-block scroll-to-reply" data-scroll-to-wamid="{{ message.replied_to.wamid }}">
                    <strong>{{ message.replied_to.contact.name|default:message.replied_to.contact.wa_id }}</strong>
                    <p>
                        {% with replied_msg=message.replied_to %}
                            {% if replied_msg.message_type == 'text' %}
                                {{ replied_msg.text_content|truncatechars:50 }}
                            {% elif replied_msg.message_type == 'image' or replied_msg.message_type == 'sticker' %}
                                üì∑ Image
                                {% if replied_msg.caption %}<br><small>{{ replied_msg.caption|truncatechars:40 }}</small>{% endif %}
                            {% elif replied_msg.message_type == 'video' %}
                                üìπ Video
                                {% if replied_msg.caption %}<br><small>{{ replied_msg.caption|truncatechars:40 }}</small>{% endif %}
                            {% elif replied_msg.message_type == 'document' %}
                                üìÑ Document
                                {% if replied_msg.caption %}<br><small>{{ replied_msg.caption|truncatechars:40 }}</small>{% endif %}
                            {% elif replied_msg.message_type == 'audio' %}
                                üéµ Audio
                            {% elif replied_msg.message_type == 'location' %}
                                üìç Location
                                {% if replied_msg.text_content %}<br><small>{{ replied_msg.text_content|truncatechars:40 }}</small>{% endif %}
                            {% elif replied_msg.message_type == 'contacts' %}
                                üë§ Contact: {{ replied_msg.contact_name|truncatechars:40 }}
                            {% else %}
                                {{ replied_msg.text_content|truncatechars:50 }}
                            {% endif %}
                        {% endwith %}
                    </p>
                </a>
                {% endif %}

                {# Main Message Content Display Block #}
                {% if message.message_type == 'image' or message.message_type == 'sticker' %}
                    {% if message.media_file %}
                        <img src="{{ message.media_file.url }}" alt="Media" style="max-width: 100%; border-radius: 10px;">
                    {% endif %}
                {% elif message.message_type == 'video' %}
                    {% if message.media_file %}
                        <video controls style="max-width: 100%; border-radius: 10px;">
                            <source src="{{ message.media_file.url }}">
                            Your browser does not support the video tag.
                        </video>
                    {% endif %}
                {% elif message.message_type == 'audio' %}
                    {% if message.media_file %}
                        <audio controls src="{{ message.media_file.url }}"></audio>
                    {% endif %}
                {% elif message.message_type == 'location' %}
                    <div class="location-card">
                        <a href="https://maps.google.com/?q={{ message.latitude }},{{ message.longitude }}" target="_blank" rel="noopener noreferrer">
                            <p class="mb-1">üìç Location Shared</p>
                            {% if message.text_content %}<small>{{ message.text_content }}</small>{% endif %}
                            <span class="view-map-link">View on Google Maps ‚Üí</span>
                        </a>
                    </div>
                {% elif message.message_type == 'contacts' %}
                    {% if message.contact_name %}
                    <div class="contact-card">
                        <div class="contact-header">üë§ Contact</div>
                        <div class="contact-body">
                            <p><strong>Name:</strong> {{ message.contact_name }}</p>
                            <p><strong>Phone:</strong> {{ message.contact_phone }}</p>
                        </div>
                    </div>
                    {% endif %}
                {% elif message.message_type == 'document' %}
                    {% if message.media_file %}
                    <div class="document-card" style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.8em;">
                        {% if ".pdf" in message.media_file.name|lower %}üìï
                        {% elif ".doc" in message.media_file.name|lower %}üìò
                        {% else %}üìÑ
                        {% endif %}
                        </span>
                        <a href="{{ message.media_file.url }}" target="_blank">
                            {{ message.caption|default:message.media_file.name|truncatechars:40 }}
                        </a>
                    </div>
                    {% endif %}
                {% else %}
                    <p class="mb-1">{{ message.text_content|linebreaksbr }}</p>
                {% endif %}

                {% if message.caption %}
                    <p class="caption">{{ message.caption }}</p>
                {% endif %}

                <div class="bubble-footer">
                    <span>{{ message.timestamp|date:"h:i A" }}</span>
                    {% if message.direction == 'outbound' %}
                        {% if message.status == 'read' %}
                            <span class="status-read">‚úì‚úì</span>
                        {% elif message.status == 'delivered' %}
                            <span>‚úì‚úì</span>
                        {% else %}
                            <span>‚úì</span>
                        {% endif %}
                    {% endif %}
                </div>
                
                {% if message.status|slice:":8" == 'Reacted' %}
                    <div class="reaction-emoji">{{ message.status|slice:"13:" }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="reply-context-banner">
        <span id="reply-context-text"></span>
        <span id="cancel-reply-btn">‚úñ</span>
    </div>

    <div id="media-preview-container" class="mb-2" style="display: none; position: relative; max-width: 200px;">
    <img id="media-preview-image" src="" alt="Image Preview" class="img-fluid rounded">
    <button id="cancel-media-preview" type="button" class="btn-close" style="position: absolute; top: 5px; right: 5px; background-color: rgba(255,255,255,0.7);"></button>
</div>

    <form id="reply-form" enctype="multipart/form-data">
        <input type="hidden" id="replied-to-wamid" name="replied_to_wamid">
        <div class="input-group">
            <input type="text" id="reply-message-input" class="form-control" placeholder="Type a message...">
            <label class="btn btn-secondary mb-0" for="media-file-input">üìé</label>
            <input type="file" id="media-file-input" name="media_file" style="display: none;">
            <button type="submit" class="btn btn-primary">Send</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatContainer = document.getElementById('chat-container');
    const replyForm = document.getElementById('reply-form');
    const messageInput = document.getElementById('reply-message-input');
    const repliedToWamidInput = document.getElementById('replied-to-wamid');
    const replyBanner = document.getElementById('reply-context-banner');
    const replyBannerText = document.getElementById('reply-context-text');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    const csrfToken = "{{ csrf_token }}";
    const mediaInput = document.getElementById('media-file-input');
    const previewContainer = document.getElementById('media-preview-container');
    const previewImage = document.getElementById('media-preview-image');
    const cancelPreviewBtn = document.getElementById('cancel-media-preview');

    // Scroll to the bottom of the chat on page load
    chatContainer.scrollTop = chatContainer.scrollHeight;


      document.querySelectorAll('.scroll-to-reply').forEach(link => {
        link.addEventListener('click', (event) => {
            // Stop the default instant jump
            event.preventDefault(); 

            const targetWamid = link.dataset.scrollToWamid;
            const targetElement = document.getElementById(targetWamid);

            if (targetElement) {
                // Smoothly scroll the target message into the middle of the screen
                targetElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });

                // Add the temporary highlight effect
                targetElement.classList.add('highlight');

                // Remove the highlight effect after the animation is done (1.5 seconds)
                setTimeout(() => {
                    targetElement.classList.remove('highlight');
                }, 1500);
            }
        });
    });

    
    cancelPreviewBtn.addEventListener('click', () => {
        mediaInput.value = ''; // This clears the selected file
        previewImage.src = '';
        previewContainer.style.display = 'none';
    });
    mediaInput.addEventListener('change', () => {
        const file = mediaInput.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    document.querySelectorAll('.reply-btn').forEach(button => {
        button.addEventListener('click', () => {
            const wamid = button.dataset.wamid;
            const text = button.dataset.text;
            repliedToWamidInput.value = wamid;
            replyBannerText.textContent = `Replying to: "${text}"`;
            replyBanner.style.display = 'block';
            messageInput.focus();
        });
    });

    cancelReplyBtn.addEventListener('click', () => {
        repliedToWamidInput.value = '';
        replyBanner.style.display = 'none';
    });

    replyForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const messageText = messageInput.value.trim();
        const file = mediaInput.files[0];
        const repliedToWamid = repliedToWamidInput.value;

        // --- THIS IS THE MISSING FIX ---
        // If there is no text AND no file, do not submit the form.
        if (!messageText && !file) {
            return; 
        }
        const formData = new FormData(replyForm);
        formData.append('to_number', "{{ contact.wa_id }}");
        formData.append('message_text', messageText); // Ensure trimmed text is what's sent
         if (file) {
            formData.append('media_file', file);
        }
        if (repliedToWamid) {
            formData.append('replied_to_wamid', repliedToWamid);
        }
        messageInput.disabled = true;

        try {
            const response = await fetch("{% url 'registration:send_reply_api' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData,
            });
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to send message. Please check the server logs.');
                messageInput.disabled = false;
            }
        } catch (error) {
            console.error('Error sending reply:', error);
            alert('An error occurred.');
            messageInput.disabled = false;
        }
    });
});
</script>
{% endblock %}