{% extends 'registration/base.html' %}
{% load static %}

{% block title %}Job Requests{% endblock %}

{% block extra_styles %}
    /* Styles for Job Cards, Tabs, Tags, etc. */
     .selected-leaders-container {
        padding-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .leader-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.3em 0.75em;
        font-size: 0.9em;
    }
    .job-card { background-color: #fff; border: 1px solid #e9ecef; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; transition: all 0.3s ease; }
    .job-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-color: #667eea; }
    .job-title a { color: #212529; text-decoration: none; }
    .job-title a:hover { color: #667eea; }
    .job-details, .job-meta { color: #6c757d; font-size: 0.9rem; }
    .job-details i, .job-meta i { width: 16px; text-align: center; margin-right: 0.5rem; color: #667eea; }
    .job-rate { font-size: 1.5rem; font-weight: 700; color: #e55353; }
    .job-rate-label { font-size: 0.8rem; color: #6c757d; }
    .job-tag { font-size: 0.75rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: 50px; display: inline-block; }
    .job-tag.pending { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5;}
    .job-tag.allocated { background-color: #cfe2ff; color: #0a58ca; border: 1px solid #b6d4fe;}
    .job-tag.ongoing { background-color: #d1e7dd; color: #0f5132; border: 1px solid #b2d8c1;}
    .job-tag.completed { background-color: #e2e3e5; color: #495057; border: 1px solid #d3d6d8;}
    .sub-nav-pills .nav-link { color: #495057; font-weight: 500; border-radius: 8px; padding: 0.5rem 1rem; }
    .sub-nav-pills .nav-link.active { background-color: #667eea; color: white; }
    .badge-count { font-size: 0.75em; vertical-align: top; }
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title mb-0">Job Requests</h2>
    </div>

    <ul class="nav nav-pills sub-nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="pills-latest-tab" data-bs-toggle="pill" data-bs-target="#pills-latest" type="button" role="tab">Latest <span class="badge bg-danger rounded-pill badge-count">{{ latest_jobs|length }}</span></button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="pills-pending-tab" data-bs-toggle="pill" data-bs-target="#pills-pending" type="button" role="tab">Pending <span class="badge bg-secondary rounded-pill badge-count">{{ pending_jobs|length }}</span></button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="pills-ongoing-tab" data-bs-toggle="pill" data-bs-target="#pills-ongoing" type="button" role="tab">Ongoing <span class="badge bg-secondary rounded-pill badge-count">{{ ongoing_jobs|length }}</span></button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="pills-completed-tab" data-bs-toggle="pill" data-bs-target="#pills-completed" type="button" role="tab">Completed <span class="badge bg-secondary rounded-pill badge-count">{{ completed_jobs|length }}</span></button></li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-latest" role="tabpanel">
            {% for job in latest_jobs %}{% include 'registration/partials/job_card.html' %}{% empty %}
            <div class="alert alert-light text-center p-4">✨ No new job requests in the last 4 days.</div>{% endfor %}
        </div>
        <div class="tab-pane fade" id="pills-pending" role="tabpanel">
            {% for job in pending_jobs %}{% include 'registration/partials/job_card.html' %}{% empty %}
            <div class="alert alert-light text-center p-4">No older jobs are pending allocation.</div>{% endfor %}
        </div>
        <div class="tab-pane fade" id="pills-ongoing" role="tabpanel">
            {% for job in ongoing_jobs %}{% include 'registration/partials/job_card.html' %}{% empty %}
            <div class="alert alert-light text-center p-4">No jobs are currently ongoing.</div>{% endfor %}
        </div>
        <div class="tab-pane fade" id="pills-completed" role="tabpanel">
            {% for job in completed_jobs %}{% include 'registration/partials/job_card.html' %}{% empty %}
            <div class="alert alert-light text-center p-4">No jobs have been completed yet.</div>{% endfor %}
        </div>
    </div>

    {% for job in all_jobs %}
   <div class="modal fade" id="allocateTeamModal-{{ job.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Allocate Team for: {{ job.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body">
                <div class="alert alert-secondary"><strong>{{ job.workers_needed }} workers needed</strong> for <strong>{{ job.duration_days }} days</strong> at <strong>₹{{ job.rate }}/day</strong>.</div>
                
                <form class="allocation-form">
                    <div id="leader-fields-container-{{ job.id }}">
                        <div class="row g-2 mb-2 align-items-center leader-row">
                            <div class="col-sm-6">
                                <label class="form-label small">Team Leader</label>
                                <select class="form-select leader-select">
                                    <option value="" data-contact="">Select a leader...</option>
                                    {% for leader in team_leaders %}
                                    <option value="{{ leader.id }}" data-contact="{{ leader.contact_number }}">{{ leader.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-sm-5">
                                <label class="form-label small">Leader Contact</label>
                                <input type="tel" class="form-control leader-contact-input" placeholder="Contact number" readonly>
                            </div>
                            <div class="col-sm-1 d-flex align-items-end">
                                </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                         <button type="button" class="btn btn-sm btn-outline-primary btn-add-leader">
                            <i class="fas fa-plus me-1"></i> Add More Leaders
                        </button>
                    </div>

                    <hr>
                    <div class="mb-3"><label class="form-label">Number of Workers to Allocate</label><input type="number" class="form-control" value="{{ job.workers_needed }}"></div>
                    <div class="mb-3"><label class="form-label">Estimated Start Date</label><input type="date" class="form-control" min="{{ today_date }}"></div>
                    <div class="mb-3"><label class="form-label">Additional Notes</label><textarea class="form-control" rows="3"></textarea></div>
                </form>
            </div>

            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>Send Request</button>
            </div>
        </div>
    </div>
</div>

<template id="leader-row-template">
    <div class="row g-2 mb-2 align-items-center leader-row">
        <div class="col-sm-6">
            <select class="form-select leader-select">
                <option value="" data-contact="">Select a leader...</option>
                {% for leader in team_leaders %}
                <option value="{{ leader.id }}" data-contact="{{ leader.contact_number }}">{{ leader.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-sm-5">
            <input type="tel" class="form-control leader-contact-input" placeholder="Contact number" readonly>
        </div>
        <div class="col-sm-1 d-flex align-items-end">
            <button type="button" class="btn btn-sm btn-outline-danger btn-remove-leader" title="Remove">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    </div>
</template>
    {% endfor %}
{% endblock %}
{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const leaderTemplate = document.querySelector('#leader-row-template');

    // EVENT LISTENER FOR THE 'ADD MORE' BUTTON
    document.body.addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-add-leader')) {
            const modal = event.target.closest('.modal');
            const container = modal.querySelector('[id^="leader-fields-container-"]');
            
            // Clone the template content
            const newRow = leaderTemplate.content.cloneNode(true);
            container.appendChild(newRow);
        }
    });

    // EVENT LISTENER FOR REMOVING A ROW
    document.body.addEventListener('click', function(event) {
        // Find the closest remove button to where the user clicked
        const removeButton = event.target.closest('.btn-remove-leader');
        if (removeButton) {
            const rowToRemove = removeButton.closest('.leader-row');
            rowToRemove.remove();
        }
    });

    // EVENT LISTENER FOR AUTO-FILLING THE PHONE NUMBER
    document.body.addEventListener('change', function(event) {
        if (event.target.classList.contains('leader-select')) {
            const selectElement = event.target;
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const contactNumber = selectedOption.getAttribute('data-contact');
            
            const parentRow = selectElement.closest('.leader-row');
            const contactInput = parentRow.querySelector('.leader-contact-input');
            
            contactInput.value = contactNumber || ''; // Set value or empty string
        }
    });
});
</script>
{% endblock %}